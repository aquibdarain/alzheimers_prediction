# services/report_service.py
import os
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import mm
from reportlab.pdfgen import canvas
from datetime import datetime
from flask import current_app

def generate_report(uniq, uploaded_image, heatmap_path, label, probabilities):
    out = os.path.join(current_app.config.get("UPLOAD_DIR","uploads"), f"{uniq}_report.pdf")
    p0,p1,p2 = probabilities
    now = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

    c = canvas.Canvas(out, pagesize=A4)
    width, height = A4
    margin = 15*mm
    y = height - margin

    c.setFont("Helvetica-Bold", 16)
    c.drawString(margin, y, "Alzheimer's Screening Report")
    c.setFont("Helvetica", 9)
    c.drawRightString(width - margin, y, now)
    y -= 12*mm

    c.setFont("Helvetica-Bold", 11)
    c.drawString(margin, y, f"Predicted: {label}")
    y -= 8*mm
    c.setFont("Helvetica", 9)
    c.drawString(margin, y, f"Confidence - Normal: {p0:.2%}   MCI: {p1:.2%}   Alzheimer: {p2:.2%}")
    y -= 12*mm

    img_w = (width - 2*margin - 10*mm) / 2
    img_h = img_w * 0.75

    try:
        c.drawImage(uploaded_image, margin, y - img_h, width=img_w, height=img_h, preserveAspectRatio=True)
    except Exception:
        c.drawString(margin, y - 10, "Failed to embed uploaded image")

    try:
        if heatmap_path:
            c.drawImage(heatmap_path, margin + img_w + 10*mm, y - img_h, width=img_w, height=img_h, preserveAspectRatio=True)
    except Exception:
        c.drawString(margin + img_w + 10*mm, y - 10, "Failed to embed heatmap")

    y = y - img_h - 10*mm

    # Interpretation
    alz_prob = p2
    if alz_prob >= 0.6:
        interp = "High likelihood of Alzheimer’s pattern detected — urgent clinical follow up recommended."
    elif alz_prob >= 0.3:
        interp = "Moderate likelihood — recommend specialist consultation and additional tests."
    else:
        interp = "Low likelihood — routine monitoring advised; correlate clinically."

    c.setFont("Helvetica-Bold", 10)
    c.drawString(margin, y, "Interpretation:")
    y -= 6*mm
    c.setFont("Helvetica", 9)
    c.drawString(margin, y, interp)
    y -= 12*mm

    c.setFont("Helvetica", 7)
    disclaimer = ("Disclaimer: This report is generated by an AI screening tool for research/educational "
                  "purposes only. It is not a medical diagnosis. Clinical correlation required.")
    c.drawString(margin, 20*mm, disclaimer)

    c.showPage()
    c.save()
    current_app.logger.info("Generated PDF report: %s", out)
    return out
